---
title: "Practica 1. Matching"
author: "Carlos Bautista"
date: '2022-10-17'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(haven)
library(tidyverse)
library(dplyr)
library(stargazer)
library(knitr)
library(magrittr)
library(kableExtra)
library(MatchIt)
```

## Práctica 1. Matching

**Referencia**: Dehejia, Rajeev H., and Sadek Wahba. 2002. Propensity Score-
Matching Methods for Nonexperimental Causal Studies. Review of Economics
and Statistics 84 (1): 151–61.

En esta práctica analizaremos el artículo de Dehejia y Wahba (2002), y replica-
mos algunos de sus principales resultados. Los autores utilizan la metodología
de matching para examinar el efecto de un programa de capacitación laboral
en EUA (NSW job training program). Para realizar este análisis, utilizaremos el
conjunto de datos adjunto a su artículo. Este conjunto de datos está disponible
en Canvas y fue tomado de:

https://mixtape.scunning.com/matching-and-subclassification.html

**1.** Revise la descripción del programa que se realiza en la Sección I y replique
la Tabla 1 de la muestra utilizada por los autores para describir a su
conjunto de datos:

```{r}
getwd()
nsw <- read_dta("data/nsw_mixtape.dta")
attach(nsw)
View(nsw)

nsw_cov <- c('age', 'educ', 'black', 'hisp', 'marr', 'nodegree', 're74', 
             're75', 're78')

tbl1 <- nsw %>% group_by(treat) %>% 
  select(one_of(nsw_cov)) %>% 
  summarise_all(funs(mean(., na.rm=T), sd(./sqrt(n()), na.rm=T)))
tbl1
```

**2.** Calcule el ATE del experimento. Deberá obtener que el efecto del NSW
job-training program sobre los ingresos reales fue un incremento de $1,794.343.
(renglón 1 de la tabla 2).

El ATE en este caso es la diferencia de medias entre grupo tratado y de control.

Realizamos prueba t y observamos que la diferencia en medias es significativa

```{r}
ate <- tbl1$re78_mean[2] - tbl1$re78_mean[1]
ate

with(nsw, t.test(re78 ~ treat))
```
```{r}
lapply(nsw_cov,
       function(v) {t.test(nsw[, v] ~ nsw[, 'treat'])})
```


**3.** Siguiendo el procedimiento de los autores, ahora utilice la información de
la encuesta CPS como grupo de control no experimental. Agregue este
conjunto de datos a los datos experimentales y estime el propensity score
usando un modelo logit.**

Unimos datos de CPS

```{r}
cps <- read_dta('data/cps_mixtape.dta')
dim(cps)
View(cps)

nsw_cps <- nsw %>% filter(treat == 1) %>% 
  bind_rows(cps)
head(nsw_cps)
```
Estimamos propensity score para modelo logit. Recordamos que la variable 
dependiente es la dicotómica del tratamiento y las independientes las variables
seleccionadas.

Estimamos modelo logit:

```{r}
nsw_cps <- nsw_cps %>% 
  mutate(re74_1k = re74/1000,
         re75_1k = re75/1000,
         re78_1k = re78/1000)
ps <- glm(treat ~ age + educ + black + hisp + marr + nodegree + re74_1k+
            re75, family = binomial(), data = nsw_cps)
summary(ps)
```

Calculamos propensity score usando modelo estimado previamente.

Observamos en los resultados que individuos con probabilidades bajas,
menores al 30%, están clasificados en el grupo de tratamiento.

```{r}
ps_df <- data.frame(pr_score = predict(ps, type= 'response'),
                    treat = ps$model$treat)
head(ps_df)
tail(ps_df)
```


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
